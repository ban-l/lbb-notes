# DB连接池使用率100%

## 背景

```log
【高】告警名称: jvm->数据库连接池(hikaricp)
=====================
告警详情: test-1111-2222/HikariPool-1/连接池使用率: 100%
监控取值: 1
故障时间: 2025-04-10 21:01:33
=====================
更新异常
04-10 21:00:02.704 [XNIO-1 task-49] DEBUG [test] -<== Updates: 0
04-10 21:00:02.704 [XNIO-1 task-49] INFO  [test] -失败信息: ......
04-10 21:00:02.704 [XNIO-1 task-49] ERROR [test] -更新异常：
java.sql.SQLException: 更新失败
```

## 分析

数据库连接数耗尽，从池中获取不到连接，**超时抛出`SQLException`。**
## 解决思路：资源管理(隔离/配置/释放)、流量控制、监控熔断

## 一、连接数耗尽原因

1. **连接池大小**：连接池的最大连接数 (`maximumPoolSize`)。
2. **事务管理**：每个更新语句是否在一个独立的事务中，事务的提交和回滚是否及时。
3. **数据库性能**：数据库处理`DML`语句的速度。
4. **连接复用**：连接池是否能有效地复用连接。

## 二、举例分析：每秒200个update语句

连接池大小：
- 假设 HikariCP 的 `maximumPoolSize` 为 10，那么最多只能同时有 10 个连接。
- 每秒 200 个更新语句意味着每秒钟需要 200 个连接，显然超过了连接池的最大连接数。

事务管理：
- 如果每个更新语句都在一个独立的事务中，并且事务提交或回滚后立即释放连接，那么连接池可以复用这些连接。
- 如果事务没有及时提交或回滚，连接会被长时间占用，导致连接池中的连接被耗尽。

数据库性能：
- 数据库处理更新语句的速度也会影响连接的使用情况。
- 如果数据库处理速度足够快，连接可以快速释放并复用。
- 如果数据库处理速度较慢，连接可能会被长时间占用。

连接复用：
- HikariCP 是一个高效的连接池，能够很好地复用连接。
- 但如果每秒的请求量远超过连接池的最大连接数，仍然会导致连接不足。

## 三、解决方案

**增加连接池大小**：

- 根据实际需求，适当增加 `maximumPoolSize`。例如，可以将其设置为 50 或更高。

```
spring.datasource.hikari.maximum-pool-size=50
```

**优化事务管理**：

- 确保每个更新语句在一个独立的事务中，并且事务提交或回滚后立即释放连接。
- 使用批量更新来减少事务的数量，提高效率。

**数据库优化**：

- 优化数据库索引和查询，提高数据库处理更新语句的速度。
- 考虑使用数据库的并发控制机制，如分区表、索引优化等。

**异步处理**：

- 使用异步处理机制，将更新操作放入队列中异步执行，减少对连接池的压力。

## 四、结论

每秒200个更新语句确实有可能导致连接池中的连接数被耗尽，特别是当连接池大小较小时。

通过增加连接池大小、优化事务管理、数据库优化和使用异步处理等方法，可以有效缓解这一问题。

