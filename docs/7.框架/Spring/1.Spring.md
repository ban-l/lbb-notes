# Spring

## **概念**

Spring是一个**轻量级、开源的企业级Java应用程序开发框架**，其核心目标是简化Java企业级开发，提供一种"一站式"解决方案。

### **一、Spring的核心设计思想**

#### **1. 控制反转 (IoC - Inversion of Control)**
- **传统方式**：对象自己创建和管理依赖
- **Spring方式**：对象的创建和依赖管理交给Spring容器
- **示例对比**：

```java
// 传统方式：主动创建依赖
public class UserService {
    private UserRepository repository = new UserRepositoryImpl();
}

// Spring方式：被动接收依赖（依赖注入）
@Component
public class UserService {
    private final UserRepository repository;
    
    @Autowired // 由Spring容器注入
    public UserService(UserRepository repository) {
        this.repository = repository;
    }
}
```

#### **2. 依赖注入 (DI - Dependency Injection)**
- **构造器注入**（Spring推荐的方式）
- **Setter方法注入**
- **字段注入**（使用`@Autowired`直接注入字段，不推荐用于必需依赖）

### **二、Spring框架的核心模块**

```
Spring Framework 5.x
├── 核心容器 (Core Container)
│   ├── Spring Core      - 基础工具类、IoC容器
│   ├── Spring Beans     - Bean工厂、Bean生命周期管理
│   ├── Spring Context   - ApplicationContext实现
│   └── SpEL             - Spring表达式语言
│
├── AOP (Aspect Oriented Programming)
│   └── 面向切面编程，提供声明式事务等能力
│
├── 数据访问/集成 (Data Access/Integration)
│   ├── JDBC             - 简化JDBC操作
│   ├── ORM              - 支持Hibernate、JPA等
│   ├── Transactions     - 声明式事务管理
│   └── Messaging        - 消息队列集成
│
├── Web层
│   ├── Web MVC          - Spring MVC框架
│   ├── WebFlux          - 响应式Web框架
│   └── WebSocket        - WebSocket支持
│
└── 测试 (Test)
    └── Spring Test Context框架
```

### **三、Spring的核心组件详解**

#### **1. Spring容器**
- **BeanFactory**：基础容器，提供DI功能
- **ApplicationContext**：高级容器，继承了BeanFactory，增加：
  - 国际化支持
  - 事件发布机制
  - AOP集成
  - 资源加载

```java
// 容器创建方式
// 1. ClassPathXmlApplicationContext（XML配置）
ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");

// 2. AnnotationConfigApplicationContext（注解配置）
ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);

// 3. Spring Boot方式（最常用）
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

#### **2. Bean管理**
- **Bean的作用域**：
  - `singleton`（默认）：容器中只有一个实例
  - `prototype`：每次请求都创建新实例
  - `request`：每个HTTP请求一个实例
  - `session`：每个HTTP会话一个实例
  - `application`：整个Web应用一个实例

- **Bean的生命周期**：
  1. 实例化 → 2. 属性赋值 → 3. BeanNameAware → 4. BeanFactoryAware 
  5. ApplicationContextAware → 6. 预初始化(BeanPostProcessor前置处理) 
  7. @PostConstruct → 8. InitializingBean → 9. init-method 
  10. BeanPostProcessor后置处理 → 11. 使用中 → 12. @PreDestroy 
  13. DisposableBean → 14. destroy-method

#### **3. Spring AOP（面向切面编程）**
- **核心概念**：
  - **Aspect**：切面，如日志、事务等横切关注点
  - **Join Point**：连接点，程序执行过程中的点（方法调用、异常抛出）
  - **Advice**：通知，在连接点执行的动作
  - **Pointcut**：切点，匹配连接点的表达式

```java
@Component
@Aspect
public class LoggingAspect {
    
    // 定义切点：匹配所有Service层方法
    @Pointcut("execution(* com.example.service.*.*(..))")
    public void serviceLayer() {}
    
    // 前置通知
    @Before("serviceLayer()")
    public void logBefore(JoinPoint joinPoint) {
        System.out.println("调用方法: " + joinPoint.getSignature().getName());
    }
    
    // 环绕通知
    @Around("serviceLayer()")
    public Object logExecutionTime(ProceedingJoinPoint joinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        Object result = joinPoint.proceed();
        long duration = System.currentTimeMillis() - start;
        System.out.println("方法执行时间: " + duration + "ms");
        return result;
    }
}
```

#### **4. 声明式事务管理**
```java
@Service
public class UserService {
    
    @Transactional(
        propagation = Propagation.REQUIRED,
        isolation = Isolation.READ_COMMITTED,
        rollbackFor = Exception.class,
        timeout = 30
    )
    public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
        // 业务逻辑，Spring会自动管理事务
        userRepository.deduct(fromId, amount);
        userRepository.add(toId, amount);
    }
}
```

### **四、Spring MVC架构**

```
┌─────────────────────────────────────────────┐
│           客户端请求 (HTTP Request)            │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│            DispatcherServlet                 │ ← Spring前端控制器
└──────────────────────┬──────────────────────┘
                       │
           ┌───────────┴───────────┐
           │                       │
           ▼                       ▼
┌─────────────────────┐ ┌─────────────────────┐
│ HandlerMapping      │ │ HandlerAdapter      │ ← 查找并适配处理器
│ (映射请求到Controller) │ │ (调用Controller方法) │
└─────────────────────┘ └─────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│ Controller (处理请求，返回ModelAndView)        │ ← 业务逻辑处理
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│ ViewResolver (视图解析器)                    │ ← 解析视图名称
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│ View (渲染视图)                              │ ← JSP、Thymeleaf等
└──────────────────────┬──────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────┐
│           客户端响应 (HTTP Response)           │
└─────────────────────────────────────────────┘
```

### **五、Spring Boot：Spring的"约定优于配置"实现**

**Spring Boot的核心特性**：
1. **自动配置**：基于类路径自动配置Bean
2. **起步依赖**：简化Maven/Gradle配置
3. **内嵌服务器**：Tomcat、Jetty、Undertow
4. **Actuator**：应用监控和管理
5. **外部化配置**：多种配置文件格式支持

```java
// Spring Boot主类
@SpringBootApplication // = @Configuration + @EnableAutoConfiguration + @ComponentScan
public class Application {
    public static void main(String[] args) {
        SpringApplication app = new SpringApplication(Application.class);
        app.setBannerMode(Banner.Mode.OFF);
        app.run(args);
    }
}
```

### **六、Spring的核心优势**

1. **松耦合**：通过DI实现组件间的解耦
2. **模块化设计**：按需引入所需模块
3. **强大的整合能力**：集成各种框架和技术栈
4. **声明式编程**：通过注解减少样板代码
5. **强大的测试支持**：提供专门的测试模块
6. **活跃的社区和生态**：拥有最丰富的Java生态系统

### **七、现代Spring技术栈**

```
Spring Framework (基础)
    │
    ├── Spring Boot (快速开发)
    │    ├── Spring Data (数据访问)
    │    │    ├── Spring Data JPA
    │    │    ├── Spring Data MongoDB
    │    │    └── Spring Data Redis
    │    │
    │    ├── Spring Security (安全)
    │    │    ├── OAuth2
    │    │    └── JWT
    │    │
    │    └── Spring Cloud (微服务)
    │         ├── Eureka/Nacos (服务发现)
    │         ├── Feign/OpenFeign (服务调用)
    │         ├── Hystrix/Sentinel (熔断降级)
    │         └── Gateway/Zuul (API网关)
    │
    └── Spring Reactive (响应式编程)
         ├── WebFlux
         └── R2DBC
```

### **八、最佳实践建议**

1. **依赖注入**：优先使用构造器注入，确保依赖不可变
2. **配置管理**：使用`@ConfigurationProperties`进行类型安全的配置
3. **异常处理**：使用`@ControllerAdvice`统一异常处理
4. **事务管理**：在服务层使用声明式事务
5. **测试**：使用`@SpringBootTest`进行集成测试

Spring框架通过其强大的IoC容器、AOP支持和丰富的模块化设计，为Java企业级应用提供了完整的解决方案。

从传统的Spring MVC到现代的Spring Boot微服务架构，Spring一直在演化，始终是Java生态系统的核心支柱。